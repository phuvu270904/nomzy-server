<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Order Management Test</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { border: 1px solid #ddd; margin: 20px 0; padding: 20px; }
        .logs { background: #f5f5f5; padding: 10px; height: 200px; overflow-y: auto; }
        button { margin: 5px; padding: 10px; }
        input, select { margin: 5px; padding: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebSocket Order Management System Test</h1>
        
        <!-- Connection Section -->
        <div class="section">
            <h2>Connection</h2>
            <input type="text" id="jwtToken" placeholder="JWT Token" style="width: 300px;">
            <select id="userRole">
                <option value="user">User (Customer)</option>
                <option value="owner">Restaurant (Owner)</option>
                <option value="driver">Driver</option>
            </select>
            <button onclick="connect()">Connect</button>
            <button onclick="disconnect()">Disconnect</button>
            <p>Status: <span id="connectionStatus">Disconnected</span></p>
        </div>

        <!-- Restaurant Actions -->
        <div class="section" id="restaurantSection" style="display: none;">
            <h2>Restaurant Actions</h2>
            <button onclick="getRestaurantOrders()">Get Restaurant Orders</button>
            <br>
            <input type="number" id="restaurantOrderId" placeholder="Order ID">
            <select id="restaurantStatus">
                <option value="confirmed">Confirmed</option>
                <option value="preparing">Preparing</option>
                <option value="ready_for_pickup">Ready for Pickup</option>
                <option value="cancelled">Cancelled</option>
            </select>
            <button onclick="updateOrderStatus('restaurant')">Update Status</button>
        </div>

        <!-- Driver Actions -->
        <div class="section" id="driverSection" style="display: none;">
            <h2>Driver Actions</h2>
            <button onclick="getAvailableOrders()">Get Available Orders</button>
            <br>
            <input type="number" id="driverOrderId" placeholder="Order ID">
            <button onclick="acceptOrder()">Accept Order</button>
            <br>
            <input type="number" id="driverUpdateOrderId" placeholder="Order ID">
            <select id="driverStatus">
                <option value="out_for_delivery">Out for Delivery</option>
                <option value="delivered">Delivered</option>
            </select>
            <button onclick="updateOrderStatus('driver')">Update Status</button>
        </div>

        <!-- Logs Section -->
        <div class="section">
            <h2>Real-time Logs</h2>
            <button onclick="clearLogs()">Clear Logs</button>
            <div class="logs" id="logs"></div>
        </div>
    </div>

    <script>
        let socket = null;
        let currentRole = null;

        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logs.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        function connect() {
            const token = document.getElementById('jwtToken').value;
            const role = document.getElementById('userRole').value;
            
            if (!token) {
                alert('Please enter a JWT token');
                return;
            }

            if (socket) {
                socket.disconnect();
            }

            currentRole = role;
            
            // Show/hide sections based on role
            document.getElementById('restaurantSection').style.display = 
                role === 'owner' ? 'block' : 'none';
            document.getElementById('driverSection').style.display = 
                role === 'driver' ? 'block' : 'none';

            socket = io('ws://localhost:3000/orders', {
                auth: { token: token }
            });

            socket.on('connect', () => {
                document.getElementById('connectionStatus').textContent = 'Connected';
                log(`Connected as ${role}`, 'success');
            });

            socket.on('disconnect', () => {
                document.getElementById('connectionStatus').textContent = 'Disconnected';
                log('Disconnected', 'error');
            });

            socket.on('error', (data) => {
                log(`Error: ${data.message}`, 'error');
            });

            // Order events
            socket.on('order-created', (data) => {
                log(`Order Created: ${JSON.stringify(data.order, null, 2)}`, 'success');
            });

            socket.on('new-order', (data) => {
                log(`New Order: ${JSON.stringify(data.order, null, 2)}`, 'success');
            });

            socket.on('order-updated', (data) => {
                log(`Order Updated: ${JSON.stringify(data.order, null, 2)}`, 'success');
            });

            socket.on('new-available-order', (data) => {
                log(`New Available Order: ${JSON.stringify(data.order, null, 2)}`, 'success');
            });

            socket.on('order-taken', (data) => {
                log(`Order Taken: Order ID ${data.orderId}`, 'info');
            });

            socket.on('order-accepted', (data) => {
                log(`Order Accepted: ${JSON.stringify(data.order, null, 2)}`, 'success');
            });

            socket.on('order-assigned', (data) => {
                log(`Order Assigned: ${JSON.stringify(data.order, null, 2)}`, 'success');
            });

            socket.on('available-orders', (data) => {
                log(`Available Orders: ${JSON.stringify(data.orders, null, 2)}`, 'info');
            });

            socket.on('restaurant-orders', (data) => {
                log(`Restaurant Orders: ${JSON.stringify(data.orders, null, 2)}`, 'info');
            });
        }

        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
        }

        function getRestaurantOrders() {
            if (!socket) {
                alert('Not connected');
                return;
            }
            socket.emit('get-restaurant-orders', {});
            log('Requested restaurant orders');
        }

        function getAvailableOrders() {
            if (!socket) {
                alert('Not connected');
                return;
            }
            socket.emit('get-available-orders', {});
            log('Requested available orders');
        }

        function acceptOrder() {
            if (!socket) {
                alert('Not connected');
                return;
            }
            const orderId = document.getElementById('driverOrderId').value;
            if (!orderId) {
                alert('Please enter order ID');
                return;
            }
            socket.emit('accept-order', { orderId: parseInt(orderId) });
            log(`Accepting order ${orderId}`);
        }

        function updateOrderStatus(source) {
            if (!socket) {
                alert('Not connected');
                return;
            }
            
            let orderId, status;
            if (source === 'restaurant') {
                orderId = document.getElementById('restaurantOrderId').value;
                status = document.getElementById('restaurantStatus').value;
            } else {
                orderId = document.getElementById('driverUpdateOrderId').value;
                status = document.getElementById('driverStatus').value;
            }
            
            if (!orderId) {
                alert('Please enter order ID');
                return;
            }
            
            socket.emit('update-order-status', { 
                orderId: parseInt(orderId), 
                status: status 
            });
            log(`Updating order ${orderId} to ${status}`);
        }
    </script>
</body>
</html>
