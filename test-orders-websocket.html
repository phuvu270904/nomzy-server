<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orders WebSocket Test Client</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: flex;
            gap: 20px;
        }
        .section {
            flex: 1;
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 5px;
        }
        .messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            background: #f9f9f9;
        }
        button {
            margin: 5px;
            padding: 8px 15px;
            cursor: pointer;
        }
        input, select {
            margin: 5px;
            padding: 5px;
        }
    </style>
</head>
<body>
    <h1>Orders WebSocket Test Client</h1>
    
    <div>
        <h3>Connection Settings</h3>
        <label>User ID: <input type="number" id="userId" value="1"></label>
        <label>Role: 
            <select id="userRole">
                <option value="user">User</option>
                <option value="owner">Restaurant Owner</option>
                <option value="driver">Driver</option>
            </select>
        </label>
        <button onclick="connect()">Connect</button>
        <button onclick="disconnect()">Disconnect</button>
        <span id="connectionStatus">Disconnected</span>
    </div>

    <div class="container">
        <div class="section">
            <h3>Messages</h3>
            <div id="messages" class="messages"></div>
            <button onclick="clearMessages()">Clear Messages</button>
        </div>

        <div class="section">
            <h3>Actions</h3>
            
            <div>
                <h4>Order Management</h4>
                <label>Order ID: <input type="number" id="orderId" value="1"></label>
                <br>
                <button onclick="joinOrderRoom()">Join Order Room</button>
            </div>

            <div>
                <h4>Status Updates</h4>
                <label>Status: 
                    <select id="orderStatus">
                        <option value="pending">Pending</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="preparing">Preparing</option>
                        <option value="ready_for_pickup">Ready for Pickup</option>
                        <option value="out_for_delivery">Out for Delivery</option>
                        <option value="delivered">Delivered</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </label>
                <br>
                <button onclick="updateOrderStatus()">Update Status</button>
            </div>

            <div>
                <h4>Driver Actions</h4>
                <button onclick="acceptOrder()">Accept Order</button>
                <button onclick="declineOrder()">Decline Order</button>
            </div>

            <div>
                <h4>Test Order Creation</h4>
                <button onclick="createTestOrder()">Create Test Order (REST API)</button>
            </div>
        </div>
    </div>

    <script>
        let socket = null;

        function addMessage(message) {
            const messages = document.getElementById('messages');
            const timestamp = new Date().toLocaleTimeString();
            messages.innerHTML += `<div><strong>[${timestamp}]</strong> ${message}</div>`;
            messages.scrollTop = messages.scrollHeight;
        }

        function connect() {
            const userId = document.getElementById('userId').value;
            const role = document.getElementById('userRole').value;
            
            if (socket) {
                socket.disconnect();
            }

            socket = io('ws://localhost:8190/orders', {
                query: {
                    userId: userId,
                    role: role
                }
            });

            socket.on('connect', () => {
                document.getElementById('connectionStatus').textContent = 'Connected';
                document.getElementById('connectionStatus').style.color = 'green';
                addMessage(`Connected as ${role} (ID: ${userId})`);
            });

            socket.on('disconnect', () => {
                document.getElementById('connectionStatus').textContent = 'Disconnected';
                document.getElementById('connectionStatus').style.color = 'red';
                addMessage('Disconnected from server');
            });

            socket.on('new-order', (data) => {
                addMessage(`üÜï <strong>New Order:</strong> ${JSON.stringify(data, null, 2)}`);
            });

            socket.on('order-request', (data) => {
                addMessage(`üöó <strong>Order Request:</strong> ${JSON.stringify(data, null, 2)}`);
            });

            socket.on('driver-assigned', (data) => {
                addMessage(`‚úÖ <strong>Driver Assigned:</strong> ${JSON.stringify(data, null, 2)}`);
            });

            socket.on('order-status-updated', (data) => {
                addMessage(`üìä <strong>Status Updated:</strong> ${JSON.stringify(data, null, 2)}`);
            });

            socket.on('order-cancelled', (data) => {
                addMessage(`‚ùå <strong>Order Cancelled:</strong> ${JSON.stringify(data, null, 2)}`);
            });

            socket.on('joined-order-room', (data) => {
                addMessage(`üè† <strong>Joined Room:</strong> order_${data.orderId}`);
            });

            socket.on('error', (data) => {
                addMessage(`‚ö†Ô∏è <strong>Error:</strong> ${data.message}`);
            });

            socket.on('connect_error', (error) => {
                addMessage(`‚ö†Ô∏è <strong>Connection Error:</strong> ${error.message}`);
            });
        }

        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
        }

        function joinOrderRoom() {
            if (!socket) {
                addMessage('‚ùå Not connected to server');
                return;
            }
            const orderId = parseInt(document.getElementById('orderId').value);
            socket.emit('join-order-room', { orderId });
            addMessage(`üì° Joining order room: ${orderId}`);
        }

        function updateOrderStatus() {
            if (!socket) {
                addMessage('‚ùå Not connected to server');
                return;
            }
            const orderId = parseInt(document.getElementById('orderId').value);
            const status = document.getElementById('orderStatus').value;
            
            socket.emit('update-order-status', {
                orderId,
                status,
                location: { lat: 40.7128, lng: -74.0060 } // Sample location
            });
            addMessage(`üì° Updating order ${orderId} status to: ${status}`);
        }

        function acceptOrder() {
            if (!socket) {
                addMessage('‚ùå Not connected to server');
                return;
            }
            const orderId = parseInt(document.getElementById('orderId').value);
            socket.emit('driver-accept-order', { orderId });
            addMessage(`üì° Driver accepting order: ${orderId}`);
        }

        function declineOrder() {
            if (!socket) {
                addMessage('‚ùå Not connected to server');
                return;
            }
            const orderId = parseInt(document.getElementById('orderId').value);
            socket.emit('driver-decline-order', { orderId });
            addMessage(`üì° Driver declining order: ${orderId}`);
        }

        async function createTestOrder() {
            try {
                const response = await fetch('http://localhost:8190/api/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MiwiZW1haWwiOiJ1c2VyQGdtYWlsLmNvbSIsInJvbGUiOiJ1c2VyIiwiaWF0IjoxNzU2NjMzMDM3LCJleHAiOjE3NTY3MTk0Mzd9.Ximyh3Sct1lDVxMka0LLh10RL4c4bzEmENeg0z9EsSg',
                    },
                    body: JSON.stringify({
                        userId: 2,
                        restaurantId: 3,
                        addressId: 1,
                        orderItems: [
                            {
                                productId: 1,
                                quantity: 2,
                                unitPrice: 12.99,
                                subtotal: 25.98
                            }
                        ],
                        subtotal: 25.98,
                        deliveryFee: 3.99,
                        total: 29.97,
                        paymentMethod: 'cash_on_delivery',
                        notes: 'Test order via WebSocket client'
                    })
                });

                if (response.ok) {
                    const order = await response.json();
                    addMessage(`‚úÖ <strong>Order Created:</strong> ID ${order.id}`);
                    document.getElementById('orderId').value = order.id;
                } else {
                    const error = await response.text();
                    addMessage(`‚ùå <strong>Failed to create order:</strong> ${error}`);
                }
            } catch (error) {
                addMessage(`‚ùå <strong>Network Error:</strong> ${error.message}`);
            }
        }

        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
        }

        // Auto-connect on page load
        window.addEventListener('load', () => {
            addMessage('üìñ WebSocket test client loaded. Click Connect to start.');
        });
    </script>
</body>
</html>
